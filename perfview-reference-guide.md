# PerfView リファレンスガイド

このガイドでは、PerfViewを使用して収集したETLファイルからパフォーマンスデータを効果的に参照・分析する方法について詳しく説明します。

## 目次

1. [基本的なUIナビゲーション](#1-基本的なuiナビゲーション)
2. [主要な分析ビュー](#2-主要な分析ビュー)
3. [データの絞り込みとフィルタリング](#3-データの絞り込みとフィルタリング)
4. [スタック分析テクニック](#4-スタック分析テクニック)
5. [効果的な検索パターン](#5-効果的な検索パターン)
6. [メモリ分析](#6-メモリ分析)
7. [イベント分析](#7-イベント分析)
8. [CPUプロファイリング](#8-cpuプロファイリング)
9. [シナリオ別の参照ガイド](#9-シナリオ別の参照ガイド)
10. [高度なデータエクスポート](#10-高度なデータエクスポート)

## 1. 基本的なUIナビゲーション

### メイン画面の構成

PerfViewのメイン画面は以下の要素で構成されています：

- **左側ナビゲーションパネル**: トレースファイル内の各種ビューへのアクセス
- **上部ツールバー**: 主要機能へのアクセス
- **メインビューエリア**: 選択されたデータの表示
- **下部ステータスバー**: 処理状況やメモリ使用量の表示

### 主要なナビゲーションショートカット

- **Alt+C**: CPU Stacksビューを開く
- **Alt+M**: Memory Stacksビューを開く
- **Alt+E**: Eventsビューを開く
- **Alt+T**: Thread Timeビューを開く
- **Ctrl+F**: 検索ボックスにフォーカス
- **F5**: 現在のビューを更新

### ツリービューナビゲーション

- クリック: ノードを選択
- ダブルクリック: ノードを展開/折りたたむ
- 右クリック: コンテキストメニューを表示
- Ctrl+クリック: 複数選択

## 2. 主要な分析ビュー

### CPU Stacks

CPU使用率に基づいたコールスタックの分析に使用します。

![CPU Stacksビュー](https://i.imgur.com/example1.png)

主要な列：
- **Name**: メソッド名
- **Inc %**: このメソッドとそのすべての子メソッドを含むCPU使用率
- **Exc %**: このメソッド自体のみのCPU使用率
- **Folded %**: 折りたたまれた子ノードのCPU使用率
- **When**: サンプルが取得された時間範囲

活用方法：
1. Inc %で降順ソートして最もCPUを消費しているメソッドを特定
2. 特定のメソッドを右クリックして「View Callers」または「View Callees」を選択
3. 「Find in Tree」機能を使用して特定のメソッドの発生箇所をすべて検索

### Thread Time

スレッドごとの実行時間とブロック状態を視覚的に表示します。

![Thread Timeビュー](https://i.imgur.com/example2.png)

主要な要素：
- **横軸**: 時間
- **縦軸**: スレッドID
- **色付きバー**: スレッドの状態（実行中、待機中など）
- **下部パネル**: 選択したスレッドのスタックトレース

活用方法：
1. 長時間実行されているスレッドや多くのブロック状態のあるスレッドを視覚的に特定
2. スレッドのバーをクリックして、その時点でのスタックトレースを表示
3. 色分けされた領域の意味を確認（緑=実行中、赤=ブロック中など）

### Events

低レベルのETWイベントをタイムライン順に表示します。

![Eventsビュー](https://i.imgur.com/example3.png)

主要な列：
- **Time MSec**: イベント発生時間（ミリ秒）
- **Process Name**: イベントを発生させたプロセス名
- **Event Name**: イベントの種類
- **Rest**: イベント固有のデータ

活用方法：
1. イベントフィルタを使用して特定のイベントタイプに絞る
2. Process Nameでフィルタリングして特定のプロセスのイベントのみを表示
3. Time MSecを使用して特定の時間範囲のイベントを分析

### GC Stacks

ガベージコレクションとメモリ割り当てに関するスタックを分析します。

主要な列：
- **GC Trigger Reason**: GCが発生した理由
- **Gen**: GCの世代
- **Pause MSec**: GCによる一時停止時間
- **% Time**: GCに費やされた時間の割合

活用方法：
1. 長時間のGC一時停止を特定
2. GCを頻繁に引き起こすメモリ割り当てパターンを特定
3. 世代別のGC発生頻度を分析

## 3. データの絞り込みとフィルタリング

### 基本的なフィルタリング

各ビューの上部にあるフィルターボックスを使用して、表示されるデータを絞り込めます：

- **単純な文字列フィルタ**: `"SqlCommand"`
- **否定フィルタ**: `-System.Threading`（System.Threadingを含まないものを表示）
- **複合フィルタ**: `"SqlCommand" -System.Data`
- **正規表現フィルタ**: `/Sql.*Command/`

### 高度なフィルタリングオプション

- **SAMPLE:<数値>**: サンプル数を制限（例: `SAMPLE:1000`）
- **UNTIL:<時間>**: 指定した時間までのサンプルに制限
- **AFTER:<時間>**: 指定した時間以降のサンプルに制限
- **PERCENT:<割合>**: 割合でフィルタリング（例: `PERCENT:10`）

### グループ化と集計

「Group By」オプションを使用してデータをグループ化：

1. 「Group By」ドロップダウンで以下のオプションから選択：
   - Module（モジュール別）
   - Process（プロセス別）
   - Thread（スレッド別）
   - Time（時間別）
2. 「New Grouping」を選択してカスタムグループ化を定義

## 4. スタック分析テクニック

### スタックの読み方

PerfViewでのスタック表示は、以下の順序で読みます：
- 一番上: 最初に呼び出されたメソッド（スタックの一番下）
- 一番下: 最後に呼び出されたメソッド（スタックの一番上）

```
Main
└── ProcessData
    └── ComputeValues
        └── CalculateResult  <- 最後に呼び出されたメソッド
```

### スタック分析のパターン

1. **ホットパス識別法**:
   - Inc %が高いパスを上から下へたどる
   - 各レベルで最も割合の高い子ノードを選択
   - 最終的にExc %が高いノードに到達するまで続ける

2. **呼び出し元/呼び出し先分析**:
   - 問題のメソッドを右クリック
   - 「View Callers」を選択して呼び出し元を確認
   - 「View Callees」を選択して呼び出し先を確認

3. **再帰パターン検出**:
   - 同じメソッドが繰り返し現れるスタックに注目
   - 再帰の深さと頻度を確認
   - 終了条件の最適化を検討

### フォールド/アンフォールド機能

- **フォールド**: 関連するスタックをグループ化して表示を簡略化
- **アンフォールド**: 詳細を表示するためにグループを展開

操作方法：
1. ノードを右クリック
2. 「Fold」または「Unfold」を選択
3. 「Fold %」列で折りたたまれた部分の割合を確認

## 5. 効果的な検索パターン

### 一般的な問題の検索パターン

1. **I/Oブロッキング検索**:
   - フィルタ: `"System.IO." "ReadAsync" "WriteAsync"`
   - Thread Timeビューでブロック状態（赤色）の部分を確認

2. **データベース待機検索**:
   - フィルタ: `"SqlCommand" "ExecuteReader" "ExecuteNonQuery"`
   - 長時間実行される呼び出しに注目

3. **同期コンテキスト待機検索**:
   - フィルタ: `"SynchronizationContext" "Wait" "Result"`
   - UI応答性の問題との相関関係を確認

4. **スレッドプール枯渇検索**:
   - イベントフィルタ: `"ThreadPool"`
   - Thread Timeビューでスレッド数と状態を確認
   - `"ThreadPool" "QueueUserWorkItem" "ThreadPoolEnqueue"`で検索

### 具体的な例 - スレッド枯渇検索

1. Eventsビューを開く
2. フィルタに `"ThreadPool"` と入力
3. ThreadPoolEnqueueとThreadPoolDequeueイベントのペアを見つける
4. 両者の時間差が大きい場合は枯渇の兆候
5. ThreadPoolAdjustmentReasonイベントの頻度と理由を確認
6. ThreadPoolWorkerThreadStartイベントの増加パターンを確認

## 6. メモリ分析

### GCイベント分析

1. **GC Statsビューの使用方法**:
   - 左側ナビゲーションから「GC Stats」を選択
   - 世代別のGC発生回数と時間を確認
   - Gen 2 GCの頻度が高い場合はメモリリークの可能性

2. **ヒープダンプ分析**:
   - 「Memory」→「Take Heap Snapshot」でヒープダンプを取得
   - オブジェクト数とサイズの分布を確認
   - 最も占有率の高いオブジェクトタイプを特定

### メモリリーク検出

1. **増加し続けるオブジェクトの特定**:
   - 複数のヒープスナップショットを時系列で比較
   - 「Diff」機能を使用して増加したオブジェクトを特定
   - オブジェクトの参照チェーンを追跡して保持原因を特定

2. **大きなオブジェクトヒープ分析**:
   - GC Statsで「LOH Size」列に注目
   - 85000バイト以上のオブジェクトは大きなオブジェクトヒープに配置される
   - LOHの断片化が激しい場合はパフォーマンス低下の原因になる

### メモリ割り当てホットスポット

1. **割り当てが多いメソッドの特定**:
   - 「GC Stacks」→「By Name」で降順ソート
   - 上位のメソッドに注目
   - アロケーションタイプを確認（配列、文字列、など）

2. **一時オブジェクトの最適化検討**:
   - 短命オブジェクトの割り当てパターンを特定
   - オブジェクトプールの導入検討
   - 構造体やパラメータキャッシングの活用検討

## 7. イベント分析

### 重要なイベントタイプ

1. **CLRイベント**:
   - `Microsoft-Windows-DotNETRuntime/GC`: GC関連イベント
   - `Microsoft-Windows-DotNETRuntime/Exceptions`: 例外発生イベント
   - `Microsoft-Windows-DotNETRuntime/Contention`: ロック競合イベント
   - `Microsoft-Windows-DotNETRuntime/Thread`: スレッド関連イベント
   - `Microsoft-Windows-DotNETRuntime/Loader`: アセンブリ読み込みイベント

2. **カーネルイベント**:
   - `MSNT_SystemTrace/Process`: プロセス関連イベント
   - `MSNT_SystemTrace/Thread`: スレッド関連イベント
   - `MSNT_SystemTrace/FileIO`: ファイルI/Oイベント
   - `MSNT_SystemTrace/DiskIO`: ディスクI/Oイベント
   - `MSNT_SystemTrace/TcpIp`: ネットワークイベント

### イベント分析テクニック

1. **時系列分析**:
   - Eventsビューで時間順に並べ替え
   - 特定のパターンやバースト、停止期間を特定
   - イベント間の相関関係を確認

2. **イベントペア分析**:
   - 開始・終了イベントペアの時間差を分析
   - 例：ThreadPoolEnqueue/ThreadPoolDequeue
   - 例：GC/Start/GC/Stop

3. **イベントスタッキング**:
   - イベント発生時のスタックトレースを確認
   - イベントを右クリックして「View Stack」を選択
   - 発生原因となったコードパスを特定

## 8. CPUプロファイリング

### CPUホットスポット分析

1. **インクルーシブ vs エクスクルーシブ時間**:
   - インクルーシブ（Inc %）: メソッドと子メソッドを含む合計時間
   - エクスクルーシブ（Exc %）: メソッド自体のみの時間
   - 高Inc%、低Exc%: 多くの子メソッドを呼び出す「パイプライン」メソッド
   - 高Exc%: CPU時間を直接消費する「ワーカー」メソッド

2. **JITコンパイル最適化の確認**:
   - 「Jit Stats」ビューでJITコンパイル統計を確認
   - 実行時間の長いメソッドがTier 1でのみコンパイルされている場合、最適化の余地あり
   - 「No_PGO」フラグがあるメソッドはプロファイルガイド最適化の候補

### CPU使用率の詳細な分析

1. **CPUサンプリングレートの理解**:
   - デフォルトでは1msごとにCPUサンプリング
   - サンプル数が多いほど精度が高くなる
   - 全体的なCPU使用率はサンプル数の割合で計算

2. **コールグラフ分析**:
   - 「Call Tree」ビューを使用してコールグラフを表示
   - 呼び出し関係とコストを視覚的に確認
   - ホットパスとコールドパスを特定

3. **実行時最適化（PGO）の分析**:
   - 「JitStats」ビューでPGO情報を確認
   - ホットメソッドがTier 1のままであれば最適化の余地あり
   - ループ内部の最適化状態を確認

## 9. シナリオ別の参照ガイド

### 特定スレッドの待ち状態確認

特定のスレッドがブロックされている（待ち状態）かどうかを確認するには、以下の方法があります：

1. **Thread Timeビューによる視覚的確認**:
   - 左側のナビゲーションパネルから「Thread Time」を選択
   - スレッドリストから対象のスレッドIDを探す
   - 色分けされたバーで状態を確認:
     - 赤色部分: ブロック状態（待ち状態）
     - 緑色部分: 実行中
     - 白色部分: アイドル状態
   - 赤色部分をクリックして下部パネルでスタックトレースを確認
   - スタックから待ち状態の原因を特定

2. **イベントビューによる詳細分析**:
   - 「Events」ビューを選択
   - フィルターボックスに `Thread/Start Thread/Stop Monitor/Contention ThreadID:<スレッドID>` と入力
   - 以下のようなブロック関連イベントを探す:
     - `Microsoft-Windows-DotNETRuntime/Threading/Contention`
     - `Microsoft-Windows-DotNETRuntime/Threading/Monitor`
     - `Microsoft-Windows-DotNETRuntime/Threading/Wait`
   - イベントの詳細（待機時間、理由など）を確認

3. **スタック分析による原因特定**:
   - 「CPU Stacks」または「Any Stacks」ビューを選択
   - フィルターに `Wait ThreadID:<スレッドID>` または `Monitor.Enter ThreadID:<スレッドID>` と入力
   - 表示されたスタックから待ち状態の原因となるコードパスを特定

4. **待ち状態の主な原因パターン**:
   - モニターロック待ち: `mscorlib.dll!System.Threading.Monitor.Enter`
   - I/O待ち: `System.IO.FileStream.ReadInternal` または `System.Net.Sockets.NetworkStream.Read`
   - データベース待ち: `System.Data.SqlClient.SqlCommand.ExecuteReader`
   - タスク待ち: `System.Threading.Tasks.Task.Wait` または `TaskAwaiter.GetResult`
   - スレッドプール待ち: `System.Threading.ThreadPool.WorkerThread.WaitCallback`

5. **判断基準**:
   - 待ち時間が100ms未満: 通常の短期的待機
   - 待ち時間が100ms～1秒: 要注意の待機状態
   - 待ち時間が1秒以上: 深刻な待機状態（最適化の必要性大）

### スレッド枯渇のパターン分析

1. **スレッドプールイベント確認ステップ**:
   - Eventsビューでフィルタを `"ThreadPool"` に設定
   - ThreadPoolEnqueueとDequeueの時間差を確認
   - ThreadPoolAdjustmentReasonイベントを確認
   - 理由コード「10」（キュー深度に基づく調整）が頻繁に発生していないか確認

2. **Thread Timeビューでの確認**:
   - スレッドプールスレッドの状態を確認
   - 多くのスレッドが同時にブロック状態になっていないか
   - 実行可能なスレッドが少ない時間帯があるか

3. **診断結果の判断基準**:
   - ThreadPoolEnqueueからDequeueまでの時間が1秒以上: 枯渇の可能性大
   - ThreadPoolWorkerThreadの数が急増: 枯渇に対応しようとしている状態
   - すべてのスレッドがブロック状態: 完全な枯渇状態

### SQLServerアクセスパターン分析

1. **SQLクエリの実行時間分析**:
   - Eventsビューでフィルタを `"SqlClient"` に設定
   - SQL接続開始と終了イベントのペアを確認
   - クエリ実行時間が長いイベントを特定

2. **SQLスタックトレース分析**:
   - CPU Stacksビューでフィルタを `"SqlCommand"` または `"SqlDataReader"` に設定
   - 同期的なSQLアクセス (`ExecuteNonQuery`, `ExecuteReader`) に注目
   - データベースアクセスパターンを確認（N+1問題など）

3. **診断結果の判断基準**:
   - 単一のSQLクエリが100ms以上: 最適化の余地あり
   - 同様のクエリが繰り返し実行: バッチ化の可能性
   - 同期的なデータベースアクセスが多い: 非同期化の余地あり

### I/Oパフォーマンス分析

1. **ファイルI/Oパターン分析**:
   - Eventsビューでフィルタを `"FileIO"` に設定
   - 小さなファイル操作が頻繁に発生していないか確認
   - 同期的なファイルI/O操作に注目

2. **ネットワークI/Oパターン分析**:
   - Eventsビューでフィルタを `"TcpIp"` または `"NetworkTCPIP"` に設定
   - 接続確立と切断の頻度を確認
   - データ送受信のパターンを確認

3. **診断結果の判断基準**:
   - 小さなI/O操作の頻発: バッファリング導入の余地
   - 同期的なI/O: 非同期I/Oへの移行検討
   - ネットワーク接続の頻繁な確立/切断: 接続プールの検討

## 10. 高度なデータエクスポート

### データのエクスポート

1. **CSVエクスポート**:
   - 任意のビューで右クリック→「Save View As CSV」を選択
   - フィルタリング済みのデータがCSV形式で保存される
   - スプレッドシートでさらに分析可能

2. **XMLエクスポート**:
   - 右クリック→「Save View As XML」を選択
   - より詳細な構造情報が保持される
   - カスタム分析ツールでの処理に適している

3. **レポート生成**:
   - 「File」→「Export Report」を選択
   - 主要な統計情報とグラフを含むHTMLレポートが生成される
   - チーム内での共有や文書化に最適

### プログラムによるデータ処理

1. **TraceEventを使用したプログラム的アクセス**:
   - Microsoft.Diagnostics.Tracingライブラリを使用
   - ETLファイルをプログラムで解析可能
   - カスタム分析ロジックの実装

2. **コマンドラインでの処理**:
   - PerfViewの自動化コマンド:
   ```
   PerfView /ProcessName:YourApp.exe /DataFile:output.etl analyze
   ```
   - バッチ処理やCI/CDパイプラインでの自動分析に使用可能

---

## 付録A: フィルター式早見表

| 目的 | フィルター式 |
|------|------------|
| スレッドプール関連 | `"ThreadPool" "QueueUserWorkItem" "ThreadPoolWait"` |
| SQL Server接続 | `"SqlClient" "SqlCommand" "ExecuteReader"` |
| ファイルI/O | `"System.IO.File" "ReadAllText" "WriteAllText"` |
| 非同期関連 | `"Task" "Async" "Await" "ContinueWith"` |
| 例外発生 | `"Exception" "throw" "catch"` |
| GC関連 | `"GC" "Collect" "WaitForPendingFinalizers"` |
| ロック競合 | `"Monitor" "Lock" "Semaphore" "Mutex"` |

## 付録B: キーボードショートカット一覧

| キー | 機能 |
|------|------|
| Ctrl+O | ファイルを開く |
| Ctrl+F | 検索 |
| Ctrl+G | 特定の行に移動 |
| F5 | 更新 |
| F1 | ヘルプ表示 |
| Alt+1～9 | タブ切り替え |
| Ctrl+S | 現在のビューを保存 |
| Ctrl+P | 印刷 |
| Escape | 現在の操作をキャンセル |
