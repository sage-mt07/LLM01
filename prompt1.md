C#でREST形式とJSON形式の両方をサポートするAPIを設計したいです。
以下の要件を満たす設計の提案をお願いします。

【主要要件】
1. REST形式とJSON形式の両方をサポートする
2. ルーティングによって形式を切り分ける
3. ビジネスロジックは共通化する
4. APIの数は数百に上る可能性があるため、拡張性と保守性を重視する
5. パフォーマンスを最適化するため、API登録は起動時に一度だけ行う

【具体的に知りたい点】
1. 全体的なアーキテクチャ構成（クラス図やモジュール構成図があるとより理解しやすいです）
2. REST形式とJSON形式のリクエスト/レスポンスをどのように共通処理するか
3. APIロジックの登録と検出のメカニズム
4. エラーハンドリングの方法
5. 新しいAPIの追加方法

【サンプルとして】
製品管理と注文管理の基本的なAPIを例に、設計がどのように適用されるか示してください。

まずは概念設計とアーキテクチャのみを示してください。コードサンプルはその後で議論します。

## 1. アーキテクチャの詳細化
   提案していただいたアーキテクチャについて、以下の点についてより詳細な説明をお願いします：

1. フィルター処理の具体的な実装方法
2. API登録メカニズムの詳細（特にパフォーマンス最適化の観点から）
3. [特定のコンポーネント名]の役割と他のコンポーネントとの関係性
4. スケーラビリティの確保方法
5. ASP.NET Coreのミドルウェアパイプラインとの統合方法

可能であれば、主要なクラスの関係性を示すクラス図も提供していただけると理解が深まります。
## 2.コンポーネント詳細設計
[特定のコンポーネント]について、より詳細な設計を教えてください。特に以下の点について：

1. 主要なクラスとインターフェース
2. メソッドの責任範囲
3. エラーハンドリングの方法
4. スレッドセーフティの確保方法
5. 拡張ポイント

設計のトレードオフについても説明していただけると助かります。
## 3.サンプルコード依頼
設計について理解が深まりました。この設計に基づいた最小限のサンプルコードをお願いします。

以下の要素を含むサンプルが見たいです：
1. APIロジックプロバイダーの基本実装
2. フィルターの実装
3. 統一コントローラークラス
4. 製品取得APIのサンプル実装（REST/JSON両方）
5. Program.csでの設定方法

実際の動作を理解するため、リクエスト/レスポンスの例も示していただけると助かります。
## 4. 特定の課題への対応
設計の中で[特定の課題]について懸念があります。以下の状況についてどのように対応すべきでしょうか：

1. 大量のAPIを管理する方法（例：ファイル構成やモジュール分割）
2. 複雑なパラメータ変換が必要なケース
3. バージョニングへの対応方法
4. 認証・認可の組み込み方
5. テスト容易性の確保

実際のプロジェクトでこのような課題にどう対応するかの経験や推奨事項をお聞かせください。

## 5. 実装計画
いただいた設計とコードサンプルに基づいて、実装計画を立てたいと思います。以下の点についてアドバイスをお願いします：

1. 最初に実装すべきコンポーネントとその順序
2. マイルストーンの設定方法
3. テスト戦略（単体テスト、統合テスト）
4. リファクタリングのポイント
5. チーム開発における役割分担の推奨

段階的な実装アプローチについての提案も歓迎します。


